var _a;
import { DOC_ORIENTATION } from './models/DOC_ORIENTATION';
export class ImageCompress {
}
_a = ImageCompress;
ImageCompress.getOrientation = (file) => new Promise((resolve, reject) => {
    try {
        const reader = new FileReader();
        reader.onload = () => {
            const view = new DataView(reader.result);
            if (!view.byteLength) {
                return resolve(DOC_ORIENTATION.NotDefined);
            }
            if (view.getUint16(0, false) !== 0xffd8) {
                return resolve(DOC_ORIENTATION.NotDefined);
            }
            const length = view.byteLength;
            let offset = 2;
            while (offset < length) {
                const marker = view.getUint16(offset, false);
                offset += 2;
                if (marker === 0xffe1) {
                    if (view.getUint32((offset += 2), false) !== 0x45786966) {
                        return resolve(DOC_ORIENTATION.NotJpeg);
                    }
                    const little = view.getUint16((offset += 6), false) === 0x4949;
                    offset += view.getUint32(offset + 4, little);
                    const tags = view.getUint16(offset, little);
                    offset += 2;
                    for (let i = 0; i < tags; i++) {
                        if (view.getUint16(offset + i * 12, little) === 0x0112) {
                            return resolve(view.getUint16(offset + i * 12 + 8, little));
                        }
                    }
                }
                else if ((marker & 0xff00) !== 0xff00) {
                    break;
                }
                else {
                    offset += view.getUint16(offset, false);
                }
            }
            return resolve(DOC_ORIENTATION.NotJpeg);
        };
        reader.readAsArrayBuffer(file);
    }
    catch (e) {
        return reject(DOC_ORIENTATION.Default);
    }
});
ImageCompress.uploadFile = (render, multiple = true, rejectOnCancel = false) => new Promise(function (resolve, reject) {
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/i.test(navigator.userAgent);
    Promise.resolve(isSafari || isIOS)
        .then(onlyNative => {
        if (onlyNative) {
            return ImageCompress.generateUploadInputNative(window.document, multiple, rejectOnCancel);
        }
        else {
            return ImageCompress.generateUploadInputRenderer(render, multiple, rejectOnCancel);
        }
    })
        .then((filesList) => {
        const files = filesList ? Array.from(filesList) : [];
        const orientationPromises = files.map(file => ImageCompress.getOrientation(file));
        const readerPromises = files.map(file => ImageCompress.fileToDataURL(file));
        let orientationsResult = [];
        Promise.all(orientationPromises)
            .then((orientations) => {
            orientationsResult = orientations;
            return Promise.all(readerPromises);
        })
            .then(readerResult => {
            const resultArray = readerResult.map((parsedFile, index) => ({
                image: parsedFile.dataUrl,
                orientation: orientationsResult[index],
                fileName: parsedFile.fileName,
            }));
            if (multiple) {
                resolve(resultArray);
            }
            else {
                resolve(resultArray[0]);
            }
        });
    })
        .catch(err => reject(err));
});
ImageCompress.fileToDataURL = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            //myReader.onloadend = (progressEvent: ProgressEvent<FileReader>)
            resolve({ dataUrl: e.target.result, fileName: file.name });
        };
        try {
            reader.readAsDataURL(file);
        }
        catch (e) {
            reject(`ngx-image-compress - probably no file have been selected: ${e}`);
        }
    });
};
ImageCompress.generateUploadInputRenderer = (render, multiple = true, rejectOnCancel = false) => {
    let lock = false;
    return new Promise((resolve, reject) => {
        const inputElement = render.createElement('input');
        render.setStyle(inputElement, 'display', 'none');
        render.setProperty(inputElement, 'type', 'file');
        render.setProperty(inputElement, 'accept', 'image/*');
        if (multiple) {
            render.setProperty(inputElement, 'multiple', 'true');
        }
        render.listen(inputElement, 'click', ($event) => {
            $event.target.value = '';
        });
        render.listen(inputElement, 'change', $event => {
            lock = true;
            const files = $event.target.files;
            resolve(files);
        });
        if (rejectOnCancel) {
            window.addEventListener('focus', () => {
                setTimeout(() => {
                    if (!lock) {
                        reject(new Error('file upload on blur - no file selected'));
                    }
                }, 300);
            }, { once: true });
        }
        inputElement.click();
    });
};
ImageCompress.generateUploadInputNative = (documentNativeApi, multiple = true, rejectOnCancel = false) => {
    let lock = false;
    return new Promise((resolve, reject) => {
        const inputElement = documentNativeApi.createElement('input');
        inputElement.id = 'upload-input' + new Date();
        inputElement.style.display = 'none';
        inputElement.setAttribute('type', 'file');
        inputElement.setAttribute('accept', 'image/*');
        if (multiple) {
            inputElement.setAttribute('multiple', 'true');
        }
        documentNativeApi.body.appendChild(inputElement);
        inputElement.addEventListener('change', () => {
            lock = true;
            resolve(inputElement.files);
            documentNativeApi.body.removeChild(documentNativeApi.getElementById(inputElement.id));
        }, { once: true });
        if (rejectOnCancel) {
            window.addEventListener('focus', () => {
                setTimeout(() => {
                    if (!lock && documentNativeApi.getElementById(inputElement.id)) {
                        reject(new Error('file upload on blur - no file selected'));
                        documentNativeApi.body.removeChild(documentNativeApi.getElementById(inputElement.id));
                    }
                }, 300);
            }, { once: true });
        }
        // open file select box
        inputElement.click();
    });
};
ImageCompress.compress = (imageDataUrlSource, orientation, render, ratio = 50, quality = 50, maxwidth = 0, maxheight = 0) => new Promise(function (resolve, reject) {
    quality = quality / 100;
    ratio = ratio / 100;
    const sourceImage = new Image();
    // important for safari: we need to wait for onload event
    sourceImage.onload = () => {
        const canvas = render.createElement('canvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            return reject(`No canvas context available`);
        }
        let w = sourceImage.naturalWidth;
        let h = sourceImage.naturalHeight;
        if (!CSS.supports('image-orientation', 'from-image')) {
            if (orientation === DOC_ORIENTATION.Right || orientation === DOC_ORIENTATION.Left) {
                const t = w;
                w = h;
                h = t;
            }
        }
        const xratio = maxwidth ? maxwidth / w : 1;
        const yratio = maxheight ? maxheight / h : 1;
        ratio = Math.min(ratio, xratio, yratio);
        canvas.width = w * ratio;
        canvas.height = h * ratio;
        const TO_RADIANS = Math.PI / 180;
        if (CSS.supports('image-orientation', 'from-image') || orientation === DOC_ORIENTATION.Up) {
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
        }
        else if (orientation === DOC_ORIENTATION.Right) {
            ctx.save();
            ctx.rotate(90 * TO_RADIANS);
            ctx.translate(0, -canvas.width);
            ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
            ctx.restore();
        }
        else if (orientation === DOC_ORIENTATION.Left) {
            ctx.save();
            ctx.rotate(-90 * TO_RADIANS);
            ctx.translate(-canvas.width, 0);
            ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
            ctx.restore();
        }
        else if (orientation === DOC_ORIENTATION.Down) {
            ctx.save();
            ctx.rotate(180 * TO_RADIANS);
            ctx.translate(-canvas.width, -canvas.height);
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
            ctx.restore();
        }
        else {
            // no orientation value found - same as default UP
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
        }
        const mime = imageDataUrlSource.substr(5, imageDataUrlSource.split(';')[0].length - 5);
        // TODO test on mime
        const result = canvas.toDataURL(mime, quality);
        resolve(result);
    };
    sourceImage.onerror = e => reject(e);
    sourceImage.src = imageDataUrlSource;
});
ImageCompress.byteCount = (imgString) => encodeURI(imgString).split(/%..|./).length - 1;
ImageCompress.getImageMaxSize = async (maxSizeMb, debugMode, render, rejectOnCancel = false) => {
    const MAX_TRIES = 10;
    const bytesToMB = (bytes) => (bytes / 1024 / 1024).toFixed(2);
    if (debugMode) {
        console.debug('NgxImageCompress - Opening upload window');
    }
    const myFile = (await ImageCompress.uploadFile(render, false, rejectOnCancel));
    let compressedFile;
    for (let i = 0; i < MAX_TRIES; i++) {
        const previousSize = ImageCompress.byteCount(myFile.image);
        compressedFile = await ImageCompress.compress(myFile.image, myFile.orientation, render, 50, 100);
        const newSize = ImageCompress.byteCount(compressedFile);
        console.debug('NgxImageCompress -', 'Compression from', bytesToMB(previousSize), 'MB to', bytesToMB(newSize), 'MB');
        if (newSize >= previousSize) {
            if (i === 0) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't be reduced at all - returning the original", bytesToMB(previousSize), 'MB large');
                }
                throw { ...myFile, image: compressedFile };
            }
            else {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't be reduced more - returning the best we can, which is ", bytesToMB(previousSize), 'MB large');
                }
                throw { ...myFile, image: compressedFile };
            }
        }
        else {
            if (newSize < maxSizeMb * 1024 * 1024) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', 'Here your file', bytesToMB(newSize), 'MB large');
                }
                return { ...myFile, image: compressedFile };
            }
            else if (i === 9) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't reach the desired size after", MAX_TRIES, 'tries. Returning file ', bytesToMB(previousSize), 'MB large');
                }
                throw { ...myFile, image: compressedFile };
            }
        }
        if (debugMode) {
            console.debug('NgxImageCompress -', 'Reached', bytesToMB(newSize), 'MB large. Trying another time after', i + 1, 'times');
        }
        myFile.image = compressedFile;
    }
    if (debugMode) {
        console.debug('NgxImageCompress - Unexpected error');
    }
    throw {};
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY29tcHJlc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaW1hZ2UtY29tcHJlc3Mvc3JjL2xpYi9pbWFnZS1jb21wcmVzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBR3pELE1BQU0sT0FBTyxhQUFhOzs7QUFDZiw0QkFBYyxHQUFHLENBQUMsSUFBVSxFQUE0QixFQUFFLENBQzdELElBQUksT0FBTyxDQUFrQixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtJQUM3QyxJQUFJO1FBQ0EsTUFBTSxNQUFNLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUNoQyxNQUFNLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTtZQUNqQixNQUFNLElBQUksR0FBRyxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBcUIsQ0FBQyxDQUFDO1lBQ3hELElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNsQixPQUFPLE9BQU8sQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDOUM7WUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLLE1BQU0sRUFBRTtnQkFDckMsT0FBTyxPQUFPLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQzlDO1lBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUMvQixJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7WUFDZixPQUFPLE1BQU0sR0FBRyxNQUFNLEVBQUU7Z0JBQ3BCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUM3QyxNQUFNLElBQUksQ0FBQyxDQUFDO2dCQUNaLElBQUksTUFBTSxLQUFLLE1BQU0sRUFBRTtvQkFD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QWdCLEVBQUUsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO2lCQUN6RjtnQkFDRCxPQUFPLEVBQUMsR0FBRyxNQUFNLEVBQUUsS0FBSyxFQUFFLGNBQWMsRUFBQyxDQUFDO2FBQzdDO2lCQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDaEIsSUFBSSxTQUFTLEVBQUU7b0JBQ1gsT0FBTyxDQUFDLEtBQUssQ0FDVCxvQkFBb0IsRUFDcEIseUNBQXlDLEVBQ3pDLFNBQVMsRUFDVCx3QkFBd0IsRUFDeEIsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUN2QixVQUFVLENBQ2IsQ0FBQztpQkFDTDtnQkFDRCxNQUFNLEVBQUMsR0FBRyxNQUFNLEVBQUUsS0FBSyxFQUFFLGNBQWMsRUFBQyxDQUFDO2FBQzVDO1NBQ0o7UUFDRCxJQUFJLFNBQVMsRUFBRTtZQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsU0FBUyxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxxQ0FBcUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzdIO1FBQ0QsTUFBTSxDQUFDLEtBQUssR0FBRyxjQUFjLENBQUM7S0FDakM7SUFDRCxJQUFJLFNBQVMsRUFBRTtRQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztLQUN4RDtJQUNELE1BQU0sRUFBRSxDQUFDO0FBQ2IsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSZW5kZXJlcjJ9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtEYXRhVXJsfSBmcm9tICcuL21vZGVscy9kYXRhLXVybCc7XG5pbXBvcnQge0RPQ19PUklFTlRBVElPTn0gZnJvbSAnLi9tb2RlbHMvRE9DX09SSUVOVEFUSU9OJztcbmltcG9ydCB7VXBsb2FkUmVzcG9uc2V9IGZyb20gJy4vbW9kZWxzL3VwbG9hZC1yZXNwb25zZSc7XG5cbmV4cG9ydCBjbGFzcyBJbWFnZUNvbXByZXNzIHtcbiAgICBzdGF0aWMgZ2V0T3JpZW50YXRpb24gPSAoZmlsZTogRmlsZSk6IFByb21pc2U8RE9DX09SSUVOVEFUSU9OPiA9PlxuICAgICAgICBuZXcgUHJvbWlzZTxET0NfT1JJRU5UQVRJT04+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgICAgICAgICAgICByZWFkZXIub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KHJlYWRlci5yZXN1bHQgYXMgQXJyYXlCdWZmZXIpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXZpZXcuYnl0ZUxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoRE9DX09SSUVOVEFUSU9OLk5vdERlZmluZWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LmdldFVpbnQxNigwLCBmYWxzZSkgIT09IDB4ZmZkOCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoRE9DX09SSUVOVEFUSU9OLk5vdERlZmluZWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHZpZXcuYnl0ZUxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9mZnNldCA9IDI7XG4gICAgICAgICAgICAgICAgICAgIHdoaWxlIChvZmZzZXQgPCBsZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtlciA9IHZpZXcuZ2V0VWludDE2KG9mZnNldCwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICs9IDI7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFya2VyID09PSAweGZmZTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5nZXRVaW50MzIoKG9mZnNldCArPSAyKSwgZmFsc2UpICE9PSAweDQ1Nzg2OTY2KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKERPQ19PUklFTlRBVElPTi5Ob3RKcGVnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGl0dGxlID0gdmlldy5nZXRVaW50MTYoKG9mZnNldCArPSA2KSwgZmFsc2UpID09PSAweDQ5NDk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICs9IHZpZXcuZ2V0VWludDMyKG9mZnNldCArIDQsIGxpdHRsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFncyA9IHZpZXcuZ2V0VWludDE2KG9mZnNldCwgbGl0dGxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQgKz0gMjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhZ3M7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5nZXRVaW50MTYob2Zmc2V0ICsgaSAqIDEyLCBsaXR0bGUpID09PSAweDAxMTIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHZpZXcuZ2V0VWludDE2KG9mZnNldCArIGkgKiAxMiArIDgsIGxpdHRsZSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgobWFya2VyICYgMHhmZjAwKSAhPT0gMHhmZjAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCArPSB2aWV3LmdldFVpbnQxNihvZmZzZXQsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShET0NfT1JJRU5UQVRJT04uTm90SnBlZyk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChET0NfT1JJRU5UQVRJT04uRGVmYXVsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgc3RhdGljIHVwbG9hZEZpbGUgPSAocmVuZGVyOiBSZW5kZXJlcjIsIG11bHRpcGxlID0gdHJ1ZSwgcmVqZWN0T25DYW5jZWwgPSBmYWxzZSk6IFByb21pc2U8VXBsb2FkUmVzcG9uc2UgfCBVcGxvYWRSZXNwb25zZVtdPiA9PlxuICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBjb25zdCBpc1NhZmFyaSA9IC9eKCg/IWNocm9tZXxhbmRyb2lkKS4pKnNhZmFyaS9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCk7XG4gICAgICAgICAgICBjb25zdCBpc0lPUyA9IC9pUGFkfGlQaG9uZXxpUG9kL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KTtcblxuICAgICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKGlzU2FmYXJpIHx8IGlzSU9TKVxuICAgICAgICAgICAgICAgIC50aGVuKG9ubHlOYXRpdmUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAob25seU5hdGl2ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEltYWdlQ29tcHJlc3MuZ2VuZXJhdGVVcGxvYWRJbnB1dE5hdGl2ZSh3aW5kb3cuZG9jdW1lbnQsIG11bHRpcGxlLCByZWplY3RPbkNhbmNlbCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gSW1hZ2VDb21wcmVzcy5nZW5lcmF0ZVVwbG9hZElucHV0UmVuZGVyZXIocmVuZGVyLCBtdWx0aXBsZSwgcmVqZWN0T25DYW5jZWwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAudGhlbigoZmlsZXNMaXN0OiBGaWxlTGlzdCB8IG51bGwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsZXMgPSBmaWxlc0xpc3QgPyBBcnJheS5mcm9tKGZpbGVzTGlzdCkgOiBbXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZW50YXRpb25Qcm9taXNlcyA9IGZpbGVzLm1hcChmaWxlID0+IEltYWdlQ29tcHJlc3MuZ2V0T3JpZW50YXRpb24oZmlsZSkpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZWFkZXJQcm9taXNlcyA9IGZpbGVzLm1hcChmaWxlID0+IEltYWdlQ29tcHJlc3MuZmlsZVRvRGF0YVVSTChmaWxlKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IG9yaWVudGF0aW9uc1Jlc3VsdDogRE9DX09SSUVOVEFUSU9OW10gPSBbXTtcblxuICAgICAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChvcmllbnRhdGlvblByb21pc2VzKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKG9yaWVudGF0aW9uczogRE9DX09SSUVOVEFUSU9OW10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmllbnRhdGlvbnNSZXN1bHQgPSBvcmllbnRhdGlvbnM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHJlYWRlclByb21pc2VzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihyZWFkZXJSZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdEFycmF5ID0gcmVhZGVyUmVzdWx0Lm1hcCgocGFyc2VkRmlsZSwgaW5kZXgpID0+ICh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlOiBwYXJzZWRGaWxlLmRhdGFVcmwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbnNSZXN1bHRbaW5kZXhdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogcGFyc2VkRmlsZS5maWxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHRBcnJheSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHRBcnJheVswXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICAgICAgfSk7XG5cbiAgICBzdGF0aWMgZmlsZVRvRGF0YVVSTCA9IChmaWxlOiBGaWxlKTogUHJvbWlzZTx7ZGF0YVVybDogc3RyaW5nOyBmaWxlTmFtZTogc3RyaW5nfT4gPT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8e2RhdGFVcmw6IHN0cmluZzsgZmlsZU5hbWU6IHN0cmluZ30+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgICAgICByZWFkZXIub25sb2FkID0gKGU6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIC8vbXlSZWFkZXIub25sb2FkZW5kID0gKHByb2dyZXNzRXZlbnQ6IFByb2dyZXNzRXZlbnQ8RmlsZVJlYWRlcj4pXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh7ZGF0YVVybDogZS50YXJnZXQucmVzdWx0LCBmaWxlTmFtZTogZmlsZS5uYW1lfSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoYG5neC1pbWFnZS1jb21wcmVzcyAtIHByb2JhYmx5IG5vIGZpbGUgaGF2ZSBiZWVuIHNlbGVjdGVkOiAke2V9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBzdGF0aWMgZ2VuZXJhdGVVcGxvYWRJbnB1dFJlbmRlcmVyID0gKHJlbmRlcjogUmVuZGVyZXIyLCBtdWx0aXBsZSA9IHRydWUsIHJlamVjdE9uQ2FuY2VsID0gZmFsc2UpID0+IHtcbiAgICAgICAgbGV0IGxvY2sgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPEZpbGVMaXN0IHwgbnVsbD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaW5wdXRFbGVtZW50ID0gcmVuZGVyLmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG4gICAgICAgICAgICByZW5kZXIuc2V0U3R5bGUoaW5wdXRFbGVtZW50LCAnZGlzcGxheScsICdub25lJyk7XG4gICAgICAgICAgICByZW5kZXIuc2V0UHJvcGVydHkoaW5wdXRFbGVtZW50LCAndHlwZScsICdmaWxlJyk7XG4gICAgICAgICAgICByZW5kZXIuc2V0UHJvcGVydHkoaW5wdXRFbGVtZW50LCAnYWNjZXB0JywgJ2ltYWdlLyonKTtcblxuICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgcmVuZGVyLnNldFByb3BlcnR5KGlucHV0RWxlbWVudCwgJ211bHRpcGxlJywgJ3RydWUnKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVuZGVyLmxpc3RlbihpbnB1dEVsZW1lbnQsICdjbGljaycsICgkZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAoJGV2ZW50LnRhcmdldCBhcyBhbnkgYXMgSFRNTElucHV0RWxlbWVudCkudmFsdWUgPSAnJztcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZW5kZXIubGlzdGVuKGlucHV0RWxlbWVudCwgJ2NoYW5nZScsICRldmVudCA9PiB7XG4gICAgICAgICAgICAgICAgbG9jayA9IHRydWU7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZXM6IEZpbGVMaXN0ID0gJGV2ZW50LnRhcmdldC5maWxlcztcbiAgICAgICAgICAgICAgICByZXNvbHZlKGZpbGVzKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAocmVqZWN0T25DYW5jZWwpIHtcbiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgICAgICAgICAgICAgJ2ZvY3VzJyxcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsb2NrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ2ZpbGUgdXBsb2FkIG9uIGJsdXIgLSBubyBmaWxlIHNlbGVjdGVkJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtvbmNlOiB0cnVlfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlucHV0RWxlbWVudC5jbGljaygpO1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgc3RhdGljIGdlbmVyYXRlVXBsb2FkSW5wdXROYXRpdmUgPSAoZG9jdW1lbnROYXRpdmVBcGk6IGFueSwgbXVsdGlwbGUgPSB0cnVlLCByZWplY3RPbkNhbmNlbCA9IGZhbHNlKSA9PiB7XG4gICAgICAgIGxldCBsb2NrID0gZmFsc2U7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxGaWxlTGlzdCB8IG51bGw+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGlucHV0RWxlbWVudCA9IGRvY3VtZW50TmF0aXZlQXBpLmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG4gICAgICAgICAgICBpbnB1dEVsZW1lbnQuaWQgPSAndXBsb2FkLWlucHV0JyArIG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBpbnB1dEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgIGlucHV0RWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnZmlsZScpO1xuICAgICAgICAgICAgaW5wdXRFbGVtZW50LnNldEF0dHJpYnV0ZSgnYWNjZXB0JywgJ2ltYWdlLyonKTtcblxuICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgaW5wdXRFbGVtZW50LnNldEF0dHJpYnV0ZSgnbXVsdGlwbGUnLCAndHJ1ZScpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkb2N1bWVudE5hdGl2ZUFwaS5ib2R5LmFwcGVuZENoaWxkKGlucHV0RWxlbWVudCk7XG5cbiAgICAgICAgICAgIGlucHV0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICAgICAgICAgICdjaGFuZ2UnLFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbG9jayA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW5wdXRFbGVtZW50LmZpbGVzKTtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnROYXRpdmVBcGkuYm9keS5yZW1vdmVDaGlsZChkb2N1bWVudE5hdGl2ZUFwaS5nZXRFbGVtZW50QnlJZChpbnB1dEVsZW1lbnQuaWQpIGFzIE5vZGUpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge29uY2U6IHRydWV9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAocmVqZWN0T25DYW5jZWwpIHtcbiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgICAgICAgICAgICAgJ2ZvY3VzJyxcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsb2NrICYmIGRvY3VtZW50TmF0aXZlQXBpLmdldEVsZW1lbnRCeUlkKGlucHV0RWxlbWVudC5pZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignZmlsZSB1cGxvYWQgb24gYmx1ciAtIG5vIGZpbGUgc2VsZWN0ZWQnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50TmF0aXZlQXBpLmJvZHkucmVtb3ZlQ2hpbGQoZG9jdW1lbnROYXRpdmVBcGkuZ2V0RWxlbWVudEJ5SWQoaW5wdXRFbGVtZW50LmlkKSBhcyBOb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LCAzMDApO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7b25jZTogdHJ1ZX1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBvcGVuIGZpbGUgc2VsZWN0IGJveFxuICAgICAgICAgICAgaW5wdXRFbGVtZW50LmNsaWNrKCk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBzdGF0aWMgY29tcHJlc3MgPSAoXG4gICAgICAgIGltYWdlRGF0YVVybFNvdXJjZTogRGF0YVVybCxcbiAgICAgICAgb3JpZW50YXRpb246IERPQ19PUklFTlRBVElPTixcbiAgICAgICAgcmVuZGVyOiBSZW5kZXJlcjIsXG4gICAgICAgIHJhdGlvID0gNTAsXG4gICAgICAgIHF1YWxpdHkgPSA1MCxcbiAgICAgICAgbWF4d2lkdGggPSAwLFxuICAgICAgICBtYXhoZWlnaHQgPSAwXG4gICAgKTogUHJvbWlzZTxzdHJpbmc+ID0+XG4gICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgIHF1YWxpdHkgPSBxdWFsaXR5IC8gMTAwO1xuICAgICAgICAgICAgcmF0aW8gPSByYXRpbyAvIDEwMDtcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZUltYWdlID0gbmV3IEltYWdlKCk7XG5cbiAgICAgICAgICAgIC8vIGltcG9ydGFudCBmb3Igc2FmYXJpOiB3ZSBuZWVkIHRvIHdhaXQgZm9yIG9ubG9hZCBldmVudFxuICAgICAgICAgICAgc291cmNlSW1hZ2Uub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSByZW5kZXIuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgfCBudWxsID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWN0eCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGBObyBjYW52YXMgY29udGV4dCBhdmFpbGFibGVgKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgdyA9IHNvdXJjZUltYWdlLm5hdHVyYWxXaWR0aDtcbiAgICAgICAgICAgICAgICBsZXQgaCA9IHNvdXJjZUltYWdlLm5hdHVyYWxIZWlnaHQ7XG5cbiAgICAgICAgICAgICAgICBpZiAoIUNTUy5zdXBwb3J0cygnaW1hZ2Utb3JpZW50YXRpb24nLCAnZnJvbS1pbWFnZScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLlJpZ2h0IHx8IG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uTGVmdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHc7XG4gICAgICAgICAgICAgICAgICAgICAgICB3ID0gaDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGggPSB0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgeHJhdGlvID0gbWF4d2lkdGggPyBtYXh3aWR0aCAvIHcgOiAxO1xuICAgICAgICAgICAgICAgIGNvbnN0IHlyYXRpbyA9IG1heGhlaWdodCA/IG1heGhlaWdodCAvIGggOiAxO1xuICAgICAgICAgICAgICAgIHJhdGlvID0gTWF0aC5taW4ocmF0aW8sIHhyYXRpbywgeXJhdGlvKTtcbiAgICAgICAgICAgICAgICBjYW52YXMud2lkdGggPSB3ICogcmF0aW87XG4gICAgICAgICAgICAgICAgY2FudmFzLmhlaWdodCA9IGggKiByYXRpbztcblxuICAgICAgICAgICAgICAgIGNvbnN0IFRPX1JBRElBTlMgPSBNYXRoLlBJIC8gMTgwO1xuXG4gICAgICAgICAgICAgICAgaWYgKENTUy5zdXBwb3J0cygnaW1hZ2Utb3JpZW50YXRpb24nLCAnZnJvbS1pbWFnZScpIHx8IG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uVXApIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uUmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnNhdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnJvdGF0ZSg5MCAqIFRPX1JBRElBTlMpO1xuICAgICAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKDAsIC1jYW52YXMud2lkdGgpO1xuICAgICAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKHNvdXJjZUltYWdlLCAwLCAwLCBjYW52YXMuaGVpZ2h0LCBjYW52YXMud2lkdGgpO1xuICAgICAgICAgICAgICAgICAgICBjdHgucmVzdG9yZSgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5MZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7XG4gICAgICAgICAgICAgICAgICAgIGN0eC5yb3RhdGUoLTkwICogVE9fUkFESUFOUyk7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50cmFuc2xhdGUoLWNhbnZhcy53aWR0aCwgMCk7XG4gICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc291cmNlSW1hZ2UsIDAsIDAsIGNhbnZhcy5oZWlnaHQsIGNhbnZhcy53aWR0aCk7XG4gICAgICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLkRvd24pIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnNhdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnJvdGF0ZSgxODAgKiBUT19SQURJQU5TKTtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSgtY2FudmFzLndpZHRoLCAtY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc291cmNlSW1hZ2UsIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbm8gb3JpZW50YXRpb24gdmFsdWUgZm91bmQgLSBzYW1lIGFzIGRlZmF1bHQgVVBcbiAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBtaW1lID0gaW1hZ2VEYXRhVXJsU291cmNlLnN1YnN0cig1LCBpbWFnZURhdGFVcmxTb3VyY2Uuc3BsaXQoJzsnKVswXS5sZW5ndGggLSA1KTtcbiAgICAgICAgICAgICAgICAvLyBUT0RPIHRlc3Qgb24gbWltZVxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbnZhcy50b0RhdGFVUkwobWltZSwgcXVhbGl0eSk7XG5cbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBzb3VyY2VJbWFnZS5vbmVycm9yID0gZSA9PiByZWplY3QoZSk7XG4gICAgICAgICAgICBzb3VyY2VJbWFnZS5zcmMgPSBpbWFnZURhdGFVcmxTb3VyY2U7XG4gICAgICAgIH0pO1xuXG4gICAgc3RhdGljIGJ5dGVDb3VudCA9IChpbWdTdHJpbmc6IERhdGFVcmwpOiBudW1iZXIgPT4gZW5jb2RlVVJJKGltZ1N0cmluZykuc3BsaXQoLyUuLnwuLykubGVuZ3RoIC0gMTtcblxuICAgIHN0YXRpYyBnZXRJbWFnZU1heFNpemUgPSBhc3luYyAoXG4gICAgICAgIG1heFNpemVNYjogbnVtYmVyLFxuICAgICAgICBkZWJ1Z01vZGU6IGJvb2xlYW4sXG4gICAgICAgIHJlbmRlcjogUmVuZGVyZXIyLFxuICAgICAgICByZWplY3RPbkNhbmNlbCA9IGZhbHNlXG4gICAgKTogUHJvbWlzZTxVcGxvYWRSZXNwb25zZT4gPT4ge1xuICAgICAgICBjb25zdCBNQVhfVFJJRVMgPSAxMDtcblxuICAgICAgICBjb25zdCBieXRlc1RvTUIgPSAoYnl0ZXM6IG51bWJlcikgPT4gKGJ5dGVzIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMik7XG5cbiAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnTmd4SW1hZ2VDb21wcmVzcyAtIE9wZW5pbmcgdXBsb2FkIHdpbmRvdycpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbXlGaWxlOiBVcGxvYWRSZXNwb25zZSA9IChhd2FpdCBJbWFnZUNvbXByZXNzLnVwbG9hZEZpbGUocmVuZGVyLCBmYWxzZSwgcmVqZWN0T25DYW5jZWwpKSBhcyBVcGxvYWRSZXNwb25zZTtcblxuICAgICAgICBsZXQgY29tcHJlc3NlZEZpbGU7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNQVhfVFJJRVM7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgcHJldmlvdXNTaXplID0gSW1hZ2VDb21wcmVzcy5ieXRlQ291bnQobXlGaWxlLmltYWdlKTtcbiAgICAgICAgICAgIGNvbXByZXNzZWRGaWxlID0gYXdhaXQgSW1hZ2VDb21wcmVzcy5jb21wcmVzcyhteUZpbGUuaW1hZ2UsIG15RmlsZS5vcmllbnRhdGlvbiwgcmVuZGVyLCA1MCwgMTAwKTtcbiAgICAgICAgICAgIGNvbnN0IG5ld1NpemUgPSBJbWFnZUNvbXByZXNzLmJ5dGVDb3VudChjb21wcmVzc2VkRmlsZSk7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKCdOZ3hJbWFnZUNvbXByZXNzIC0nLCAnQ29tcHJlc3Npb24gZnJvbScsIGJ5dGVzVG9NQihwcmV2aW91c1NpemUpLCAnTUIgdG8nLCBieXRlc1RvTUIobmV3U2l6ZSksICdNQicpO1xuICAgICAgICAgICAgaWYgKG5ld1NpemUgPj0gcHJldmlvdXNTaXplKSB7XG4gICAgICAgICAgICAgICAgaWYgKGkgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkZpbGUgY2FuJ3QgYmUgcmVkdWNlZCBhdCBhbGwgLSByZXR1cm5pbmcgdGhlIG9yaWdpbmFsXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXNUb01CKHByZXZpb3VzU2l6ZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ01CIGxhcmdlJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aHJvdyB7Li4ubXlGaWxlLCBpbWFnZTogY29tcHJlc3NlZEZpbGV9O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkZWJ1Z01vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ05neEltYWdlQ29tcHJlc3MgLScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJGaWxlIGNhbid0IGJlIHJlZHVjZWQgbW9yZSAtIHJldHVybmluZyB0aGUgYmVzdCB3ZSBjYW4sIHdoaWNoIGlzIFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzVG9NQihwcmV2aW91c1NpemUpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdNQiBsYXJnZSdcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgey4uLm15RmlsZSwgaW1hZ2U6IGNvbXByZXNzZWRGaWxlfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChuZXdTaXplIDwgbWF4U2l6ZU1iICogMTAyNCAqIDEwMjQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnTmd4SW1hZ2VDb21wcmVzcyAtJywgJ0hlcmUgeW91ciBmaWxlJywgYnl0ZXNUb01CKG5ld1NpemUpLCAnTUIgbGFyZ2UnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gey4uLm15RmlsZSwgaW1hZ2U6IGNvbXByZXNzZWRGaWxlfTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPT09IDkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkZpbGUgY2FuJ3QgcmVhY2ggdGhlIGRlc2lyZWQgc2l6ZSBhZnRlclwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1BWF9UUklFUyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndHJpZXMuIFJldHVybmluZyBmaWxlICcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXNUb01CKHByZXZpb3VzU2l6ZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ01CIGxhcmdlJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aHJvdyB7Li4ubXlGaWxlLCBpbWFnZTogY29tcHJlc3NlZEZpbGV9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkZWJ1Z01vZGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCdOZ3hJbWFnZUNvbXByZXNzIC0nLCAnUmVhY2hlZCcsIGJ5dGVzVG9NQihuZXdTaXplKSwgJ01CIGxhcmdlLiBUcnlpbmcgYW5vdGhlciB0aW1lIGFmdGVyJywgaSArIDEsICd0aW1lcycpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbXlGaWxlLmltYWdlID0gY29tcHJlc3NlZEZpbGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnTmd4SW1hZ2VDb21wcmVzcyAtIFVuZXhwZWN0ZWQgZXJyb3InKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyB7fTtcbiAgICB9O1xufVxuIl19